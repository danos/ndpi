From aea91781aa476589361e16ece6aa6c10102e0f33 Mon Sep 17 00:00:00 2001
From: emanuele-f <black.silver@hotmail.it>
Date: Thu, 29 Aug 2019 14:50:17 +0200
Subject: [PATCH] Fix alignment issue on IPv6 structs

---
 src/include/ndpi_define.h.in   |  2 +-
 src/include/ndpi_typedefs.h    | 11 +++++++----
 src/lib/protocols/mdns_proto.c |  5 +++--
 3 files changed, 11 insertions(+), 7 deletions(-)

Index: ndpi/src/include/ndpi_define.h.in
===================================================================
--- ndpi.orig/src/include/ndpi_define.h.in
+++ ndpi/src/include/ndpi_define.h.in
@@ -250,7 +250,7 @@
 
 /** macro to compare 2 IPv6 addresses with each other to identify the "smaller" IPv6 address  */
 #define NDPI_COMPARE_IPV6_ADDRESS_STRUCTS(x,y)  \
-  ((((u_int64_t *)(x))[0]) < (((u_int64_t *)(y))[0]) || ( (((u_int64_t *)(x))[0]) == (((u_int64_t *)(y))[0]) && (((u_int64_t *)(x))[1]) < (((u_int64_t *)(y))[1])) )
+  ((x.u6_addr.u6_addr64[0] < y.u6_addr.u6_addr64[0]) || ((x.u6_addr.u6_addr64[0] == y.u6_addr.u6_addr64[0]) && (x.u6_addr.u6_addr64[1] < y.u6_addr.u6_addr64[1])))
 
 #define NDPI_NUM_BITS              512
 
Index: ndpi/src/include/ndpi_typedefs.h
===================================================================
--- ndpi.orig/src/include/ndpi_typedefs.h
+++ ndpi/src/include/ndpi_typedefs.h
@@ -207,27 +207,30 @@
 /* +++++++++++++++++++++++ IPv6 header +++++++++++++++++++++++ */
 /* rfc3542 */
 
+PACK_ON
 struct ndpi_in6_addr {
   union {
     u_int8_t   u6_addr8[16];
     u_int16_t  u6_addr16[8];
     u_int32_t  u6_addr32[4];
+    u_int64_t  u6_addr64[2];
   } u6_addr;  /* 128-bit IP6 address */
-};
+} PACK_OFF;
 
+PACK_ON
 struct ndpi_ip6_hdrctl {
   u_int32_t ip6_un1_flow;
   u_int16_t ip6_un1_plen;
   u_int8_t ip6_un1_nxt;
   u_int8_t ip6_un1_hlim;
-};
+} PACK_OFF;
 
-/* PACK_ON */
+PACK_ON
 struct ndpi_ipv6hdr {
   struct ndpi_ip6_hdrctl ip6_hdr;
   struct ndpi_in6_addr ip6_src;
   struct ndpi_in6_addr ip6_dst;
-} /* PACK_OFF */;
+} PACK_OFF;
 
 /* +++++++++++++++++++++++ TCP header +++++++++++++++++++++++ */
 
Index: ndpi/src/lib/protocols/mdns_proto.c
===================================================================
--- ndpi.orig/src/lib/protocols/mdns_proto.c
+++ ndpi/src/lib/protocols/mdns_proto.c
@@ -127,8 +127,9 @@
       }
 #ifdef NDPI_DETECTION_SUPPORT_IPV6
       if(packet->iphv6 != NULL) {
-	const u_int32_t *daddr = packet->iphv6->ip6_dst.u6_addr.u6_addr32;
-	if(daddr[0] == htonl(0xff020000) /* && daddr[1] == 0 && daddr[2] == 0 && daddr[3] == htonl(0xfb) */) {
+	u_int32_t daddr_0 = packet->iphv6->ip6_dst.u6_addr.u6_addr32[0];
+
+	if(daddr_0 == htonl(0xff020000) /* && daddr[1] == 0 && daddr[2] == 0 && daddr[3] == htonl(0xfb) */) {
 
 	  NDPI_LOG_INFO(ndpi_struct, "found MDNS with destination address ff02::fb\n");
 	  
