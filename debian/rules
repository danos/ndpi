#!/usr/bin/make -f

export DEB_BUILD_MAINT_OPTIONS = hardening=+all
DPKG_EXPORT_BUILDFLAGS = 1
include /usr/share/dpkg/buildflags.mk
include /usr/share/dpkg/pkg-info.mk

# Used by debian/libndpi-wireshark.install
export WIRESHARK_VERSION = $(strip $(shell apt-cache policy wireshark | grep Candidate | sed 's,.*Candidate: ,,;s,-.*,,;s,\\([0-9]*\.[0-9]*)\..*,\\1,'))

%:
	dh $@

override_dh_auto_configure:
	cp $(CURDIR)/src/lib/third_party/include/libcache.h $(CURDIR)/src/include/
	./autogen.sh
	dh_auto_configure -- --prefix=/usr

override_dh_auto_test:
	# disable generally broken tests
	rm -f tests/pcap/nintendo.pcap
	rm -f tests/pcap/skype-conference-call.pcap
	# disable tests broken on big endian
	rm -f tests/pcap/1kxun.pcap
	rm -f tests/pcap/KakaoTalk_chat.pcap
	rm -f tests/pcap/http_ipv6.pcap
	rm -f tests/pcap/quic.pcap
	rm -f tests/pcap/skype.pcap
	rm -f tests/pcap/skype_no_unknown.pcap
	rm -f tests/pcap/wechat.pcap
	rm -f tests/pcap/youtube_quic.pcap
	rm -f tests/pcap/youtubeupload.pcap
	cd tests && ./do.sh

override_dh_strip:
	dh_strip --dbgsym-migration='libndpi-dbg (<< 1.8-1~)'


PACKAGE = ndpi
GIT_COMMIT := $(shell echo $(DEB_VERSION_UPSTREAM) | grep -E -o '[~+]git[0-9]+\..*' | cut -d . -f 2 )
TARBALL = $(PACKAGE)_$(DEB_VERSION_UPSTREAM).orig.tar.gz
UPSTREAM_GIT_REPO = https://github.com/ntop/nDPI

get-orig-source:
	@echo DEB_VERSION_UPSTREAM $(DEB_VERSION_UPSTREAM)
	@echo GIT_COMMIT $(GIT_COMMIT)
ifeq ($(findstring git,$(DEB_VERSION_UPSTREAM)),)
	# Download and use upstream vanilla tarball
	uscan --verbose --force-download --download-version $(DEB_VERSION_UPSTREAM)
else
	wget $(UPSTREAM_GIT_REPO)/archive/$(GIT_COMMIT).tar.gz -O ../$(TARBALL)
endif

.PHONY: override_dh_auto_configure override_dh_strip get-orig-source
